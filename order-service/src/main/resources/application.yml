# application.yml   â€”â€” ä»¥ order-service ä¸ºä¾‹ï¼Œstock/product åªæ”¹ â¶â· å³å¯
spring.config.import: optional:nacos:${spring.application.name}.yaml   # å¼•å…¥è¿œç«¯é…ç½®
# application.yml é‡Œï¼Œå’Œ spring:/server: åŒçº§
logging:
  level:
    # Spring Cloud OpenFeign çš„è°ƒè¯•
    org.springframework.cloud.openfeign: DEBUG
    # Feign çš„æ ¸å¿ƒæ—¥å¿—
    feign: DEBUG
    # è´Ÿè½½å‡è¡¡/é‡è¯•é€‚é…å™¨ï¼ˆå¯é€‰ï¼‰
    org.springframework.cloud.openfeign.loadbalancer: DEBUG

    # Sentinel ç†”æ–­é€‚é…å™¨è°ƒè¯•
    com.alibaba.cloud.circuitbreaker.sentinel: DEBUG
    # Sentinel æ ¸å¿ƒï¼ˆæƒ³æ›´ç»†å†å¼€è¿™ä¸ªï¼‰
    com.alibaba.csp.sentinel: INFO
server:
  port: 8083            # â¶ ç«¯å£ï¼Œstock æ”¹ 8082ã€product æ”¹ 8081â€¦
  address: 127.0.0.1    # åªç›‘å¬å›ç¯å£

spring:
  application:
    name: order-service   # â· æœåŠ¡åï¼ˆä¸ Feign/Nacos æ³¨å†Œä¸€è‡´ï¼‰
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848
      discovery:
        namespace: 9aeeee1d-d284-44f8-91f2-d2c603fe916b
        ip: 127.0.0.1       # ğŸ‘ˆ å¼ºåˆ¶æ³¨å†Œåˆ° 127.0.0.1
      config:
        namespace: 9aeeee1d-d284-44f8-91f2-d2c603fe916b
        group: DEFAULT_GROUP
        file-extension: yaml
    openfeign:
      circuitbreaker:
        enabled: true
feign:
  httpclient:
    enabled: true          # ä½¿ç”¨ Apache HttpClient
    max-connections: 200
    max-connections-per-route: 50
  client:
    config:
      default:
        connectTimeout: 2000    # 2s è¿æ¥è¶…æ—¶
        readTimeout: 3000        # 3s è¯»è¶…æ—¶
        # é¿å…å’Œ Resilience4j çš„é‡è¯•å åŠ 
        retryer: feign.Retryer$NeverRetry

resilience4j:
  retry:
    instances:
      stockLock:                 # ç»™â€œé”åº“â€è°ƒç”¨ç”¨è¿™ä¸ªå®ä¾‹å
        maxAttempts: 3
        waitDuration: 500ms
        retryExceptions:
          - feign.RetryableException   # æ¨èï¼šç½‘ç»œ/è¶…æ—¶æ˜ å°„æˆå®ƒ
          - feign.FeignException       # å…œåº•ï¼ˆå¯é€‰ï¼‰
        ignoreExceptions:
          - com.xfresh.exception.BusinessException
  circuitbreaker:
    instances:
      stock:                     # æ–­è·¯å™¨å®ä¾‹å
        slidingWindowType: COUNT_BASED
        slidingWindowSize: 20
        minimumNumberOfCalls: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        automaticTransitionFromOpenToHalfOpenEnabled: true
        recordExceptions:
          - feign.FeignException
        ignoreExceptions:
          - com.xfresh.exception.BusinessException